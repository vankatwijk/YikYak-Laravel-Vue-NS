stages:   
    - testing   
    - deploy

image: registry.resttech.local:5000/php4laravel:7.3

cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"

phpunit:
    stage: testing
    script:
        - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts
        - composer update --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts
        - cp .env.testing .env
        - php artisan key:generate --env=testing
        - php artisan config:cache
        -  vendor/bin/phpunit --version
    cache:
        paths:
            - vendor/ 

deploy_staging:
    stage: deploy
    script:
        - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
        - eval $(ssh-agent -s)
        - ssh-add <(echo "$SSH_PRIVATE_KEY")     
        - mkdir -p ~/.ssh
        - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'     
        - ~/.composer/vendor/bin/envoy run deploy --commit=$CI_COMMIT_SHA --tag=$CI_COMMIT_TAG  
    environment:     
        name: staging
        url: https://cockpit.resttech.io/lo-notes-api
    when: manual
    only:
        - staging
